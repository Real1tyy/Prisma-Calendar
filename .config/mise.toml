[env]
# Dynamic plugin directory based on manifest.json id
OBSIDIAN_VAULT_PATH = "/home/real1ty/Documents/SecondBrain/SecondBrain"
# Make CI non-interactive for CI/headless environments
CI = "1"

[tools]
node = { version = "22" }       # LTS 2025-08
"npm:pnpm" = "latest"           # workspace package-manager
"npm:typescript" = "latest"     # ts-node uses this too
"npm:@biomejs/biome" = "latest" # formatter + linter in one
"npm:vitest" = "latest"         # unit-test runner

jq = "latest" # JSON parsing in shell scripts

# Code Quality Tasks (using Biome directly)
[tasks.check]
description = "Check code quality (format + lint) using Biome"
run = [
    "echo 'ğŸ” Running Biome check (format + lint)...'",
    "pnpm run check",
    "echo 'âœ… Biome check completed successfully!'",
]

[tasks.format]
description = "Format code using Biome"
run = [
    "echo 'ğŸ¨ Formatting code with Biome...'",
    "pnpm run format:fix",
    "echo 'âœ… Code formatting completed!'",
]

[tasks.lint]
description = "Lint code using Biome"
run = [
    "echo 'ğŸ” Linting code with Biome...'",
    "pnpm run lint:fix",
    "echo 'âœ… Linting completed!'",
]

[tasks.typecheck]
description = "Typecheck project using TypeScript"
run = [
    "echo 'ğŸ” Running TypeScript type checking...'",
    "pnpm run typecheck",
    "echo 'âœ… TypeScript type checking completed!'",
]

[tasks.test]
description = "Run all tests using Vitest"
run = [
    "echo 'ğŸ§ª Running all tests...'",
    "pnpm run test",
    "echo 'âœ… All tests completed!'",
]

[tasks.test-watch]
description = "Run tests in watch mode using Vitest"
run = ["echo 'ğŸ§ª Running tests in watch mode...'", "pnpm run test:watch"]

# CI Task - Main entry point for CI/CD
[tasks.ci]
description = "CI pipeline for standalone project"
run = [
    "echo 'ğŸš€ Starting CI Pipeline...'",
    "echo '  â†’ Running Biome check...'",
    "pnpm run check:fix",
    "echo '  â†’ Running TypeScript check...'",
    "pnpm run typecheck",
    "echo '  â†’ Running tests...'",
    "pnpm run test",
    "echo '  â†’ Building project...'",
    "pnpm run build",
    # "echo '  â†’ Running ESLint...'",
    # "pnpm run lint:eslint",
    "echo 'âœ… CI Pipeline completed successfully!'",
]

# Security & Maintenance
[tasks.security]
description = "Lightweight OSS licence & vuln scan"
run = [
    "echo 'ğŸ”’ Running security audit...'",
    "pnpm audit --audit-level=high || true",
    "echo 'âœ… Security audit completed!'",
]

[tasks.clean]
description = "Clean build artifacts and caches"
run = [
    "echo 'ğŸ§¹ Cleaning build artifacts and caches...'",
    "rm -rf dist",
    "rm -rf **/dist",
    "rm -rf **/main.js",
    "rm -rf node_modules/.cache",
    "echo 'âœ… Cleaned build artifacts and caches'",
]

# Git Hooks Setup
[tasks.setup-hooks]
description = "Setup git pre-commit hooks"
run = [
    "echo 'ğŸª Setting up git pre-commit hooks...'",
    "mise generate git-pre-commit --task=pre-commit --write",
    "chmod +x .git/hooks/pre-commit",
    "echo 'âœ… Pre-commit hooks installed and configured!'",
]

[tasks.pre-commit]
description = "Pre-commit validation for standalone project"
run = [
    "echo 'ğŸ” Running pre-commit checks...'",
    "echo '  â†’ Running Biome check...'",
    "pnpm run check:fix",
    "echo '  â†’ Running TypeScript check...'",
    "pnpm run typecheck",
    "echo '  â†’ Running tests...'",
    "pnpm run test",
    # "echo '  â†’ Running ESLint...'",
    # "pnpm run lint:eslint",
    "echo 'âœ… All pre-commit checks passed!'",
]

# Development workflow tasks
[tasks.fix]
description = "Auto-fix all code quality issues"
run = [
    "echo 'ğŸ”§ Auto-fixing code quality issues...'",
    "pnpm run check:fix",
    "echo 'âœ… Code quality issues fixed!'",
]

[tasks.validate]
description = "Validate project without making changes"
run = [
    "echo 'ğŸ” Validating project...'",
    "pnpm run check",
    "pnpm run typecheck",
    "echo 'âœ… Project validation completed!'",
]

[tasks.build]
description = "Build the project"
run = [
    "echo 'ğŸ—ï¸ Building project...'",
    "pnpm run build",
    "echo 'âœ… Build completed successfully!'",
]

[tasks.build-plugin]
description = "Build plugin and copy to Obsidian vault"
run = [
    "echo 'ğŸ—ï¸ Building plugin and copying to vault...'",
    "python3 scripts/dev-watcher.py --mode build",
    "echo 'âœ… Plugin build and copy completed!'",
]

[tasks.dev-watch]
description = "Start development mode with file watching and auto-copy to vault"
run = [
    "echo 'ğŸ‘€ Starting development mode with file watching...'",
    "python3 scripts/dev-watcher.py --mode watch",
]

[tasks.bump-version]
description = "Bump version in manifest.json, package.json, and versions.json (default: minor). For other types, use: python3 scripts/bump-version.py [major|minor|patch]"
run = [
    "echo 'ğŸ“¦ Bumping version (minor)...'",
    "python3 scripts/bump-version.py minor",
    "echo 'âœ… Version bump completed!'",
]

[tasks.bump-major]
description = "Bump major version in manifest.json, package.json, and versions.json"
run = [
    "echo 'ğŸ“¦ Bumping major version...'",
    "python3 scripts/bump-version.py major",
    "echo 'âœ… Major version bump completed!'",
]

[tasks.bump-minor]
description = "Bump minor version in manifest.json, package.json, and versions.json"
run = [
    "echo 'ğŸ“¦ Bumping minor version...'",
    "python3 scripts/bump-version.py minor",
    "echo 'âœ… Minor version bump completed!'",
]

[tasks.bump-patch]
description = "Bump patch version in manifest.json, package.json, and versions.json"
run = [
    "echo 'ğŸ“¦ Bumping patch version...'",
    "python3 scripts/bump-version.py patch",
    "echo 'âœ… Patch version bump completed!'",
]

[tasks.release]
description = "Create GitHub release: bump version, build plugin, and upload assets (default: minor)"
run = [
    "echo 'ğŸš€ Creating GitHub release (minor bump)...'",
    "python3 scripts/create-release.py minor",
    "echo 'âœ… Release process completed!'",
]

[tasks.release-major]
description = "Create GitHub release with major version bump: bump version, build plugin, and upload assets"
run = [
    "echo 'ğŸš€ Creating GitHub release (major bump)...'",
    "python3 scripts/create-release.py major",
    "echo 'âœ… Release process completed!'",
]

[tasks.release-minor]
description = "Create GitHub release with minor version bump: bump version, build plugin, and upload assets"
run = [
    "echo 'ğŸš€ Creating GitHub release (minor bump)...'",
    "python3 scripts/create-release.py minor",
    "echo 'âœ… Release process completed!'",
]

[tasks.release-patch]
description = "Create GitHub release with patch version bump: bump version, build plugin, and upload assets"
run = [
    "echo 'ğŸš€ Creating GitHub release (patch bump)...'",
    "python3 scripts/create-release.py patch",
    "echo 'âœ… Release process completed!'",
]

[tasks.install]
description = "Install dependencies for the project"
run = [
    "echo 'ğŸ“¦ Installing dependencies...'",
    "pnpm install",
    "echo 'âœ… Dependencies installed successfully'",
]

# Project-specific tasks (no NX dependency)
[tasks.dev-info]
description = "Show project development info"
run = [
    "echo 'ğŸ“Š Project Info:'",
    "echo '  â†’ Node version:' $(node --version)",
    "echo '  â†’ pnpm version:' $(pnpm --version)",
    "echo '  â†’ TypeScript version:' $(npx tsc --version)",
    "echo '  â†’ Biome version:' $(npx biome --version)",
]
